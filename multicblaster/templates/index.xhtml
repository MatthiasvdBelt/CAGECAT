{% extends "base.xhtml" %}
{% from "macros.xhtml" import prev_session %}
{% from "macros.xhtml" import result_table %}
{% from "macros.xhtml" import showNavigationBar %}
{% from "macros.xhtml" import renderHelpButton %}

{% block title %}
    multicblaster
{% endblock %}
{% block scripts %}
    {% if module_to_show == 'visualization' %}
showModule(undefined, 'clinkerContent');
    {% elif module_to_show == 'gne' %}
showModule(undefined, 'gneModuleContent');
    {% elif module_to_show == 'recompute' %}
showInputOptions('prev_session', 0);
$(':radio:not(:checked)').attr('disabled', true);
    {% endif %}
initReadQueryFile();
{% endblock %}

{% block navigationBar %}
    {{ showNavigationBar('home') }}
{% endblock %}

{% block content %}
<!--Module buttons-->
<div class="modules centered">
    <button class="button moduleSelector" onclick="showModule(event,
    'searchModuleContent')">Search
    </button>
    <button class="button moduleSelector" id="showGNE"
            onclick="showModule(event, 'gneModuleContent')">Neighbourhood
    </button>

    <button class="button moduleSelector" onclick="showModule(event,'clinkerContent')">Visualization</button>
</div>

<!--Module contents-->
<div>

<div id="searchModuleContent" class="moduleContent">
<form method="post" enctype="multipart/form-data" action="{{submit_url}}" onsubmit="addRequiredSeqs()" name="searchOptionForm">
    <input type="hidden" name="job_type" value="search" required="required"/>

    <label class="fieldset-label" for="inputSection">Input</label>
    <fieldset id="inputSection">

        <div class="radio-options">
            <label class="radioLabel">
                <input type="radio"  class="radio-margin" value="remote" name="mode" checked="checked" onclick="changeSearchMode('remote')">Remote
            </label>
            <label class="radioLabel">
                <input type="radio" value="hmm" name="mode" onclick="changeSearchMode('hmm')">HMM
            </label>
            <label class="radioLabel">
                <input type="radio" value="combi_remote" name="mode" onclick="changeSearchMode('combi_remote')">Remote + HMM
            </label>
        </div>

        <div class="radio-options" id="remoteOptionsSection">
                <div>
                    <label class="radioLabel">
                    <input type="radio" class="radio-margin" value="fasta" checked="checked" id="radioFasta"
                           name="inputType" onclick="showInputOptions('fasta', 1)"/>FASTA</label>
                    <label class="radioLabel">
                    <input type="radio" value="ncbi_entries" id="radioNCBIEntries"
                           name="inputType"
                           onclick="showInputOptions('ncbi_entries', 1)"/>NCBI entries
                    </label>
                    <label class="radioLabel">
                    <input type="radio" value="prev_session" id="radioPrevSession"
                           name="inputType"
                            onclick="showInputOptions('prev_session', 1)"/>Recompute
                    </label>
                </div>

            <div class="div-margin" id="genomeFileUploadDiv">
                <label class="file-upload-lbl" for="genomeFile">
                <input type="file" id="genomeFile" name="genomeFiles"
                       required="required" accept=".fasta, .fa .fsa .fna .faa" onchange="readFileContents()"/>Query file</label>
                {{ renderHelpButton('genomeFile') }}

                <div class="error-message" id="fileUploadIncorExt" style="display: none">
                    <span id="fileUploadIncorExtText"></span>
                </div>
            </div>

            <div id="ncbiEntriesDiv" style="display: none">
                <textarea rows="6" cols="25" class="ncbi-entries" id="ncbiEntriesTextArea"
                          name="ncbiEntriesTextArea" placeholder="NCBI accessions" disabled="disabled" onfocusout="validateNCBIEntries()"></textarea>
                {{ renderHelpButton('ncbiEntriesTextArea') }}
            </div>
            <div class="error-message" id="accessionsError" style="display: none">
                <span id="accessionsErrorText"></span>
            </div>
            {{ prev_session('search', false, prev_run_id, false) }}
        </div>
    </fieldset>

<div id="hmmFullFieldset" class="no-display">
    <label class="fieldset-label" for="hmmSection">Hidden Markov Models (HMM)</label>
    <fieldset id="hmmSection" disabled="disabled">
            <div id="hmmProfilesDiv">
                <div class="input-layer">
                    <label class="select-label" for="selectedGenus">Genus</label>
                    <select class="select-options" required="required" name="selectedGenus" id="selectedGenus">
                        <option value="Streptomyces">Streptomyces</option>
                    </select>
                    {{ renderHelpButton('selectedGenus') }}
                </div>
                <div class="input-layer">
                    <label class="textarea-label">HMM profiles</label>
                    <textarea rows="6" cols="25" required="required" id="hmmProfiles"
                              name="hmmProfiles" placeholder="HMM profile identifiers"></textarea>
                        {#        TODO: add Pfam identifier validation#}
                        {{ renderHelpButton('hmmProfiles') }}
                </div>
            </div>

    </fieldset>
</div>

<div id="searchSectionFullFieldset">
    <label class="fieldset-label" for="searchSection">Search</label>
    <fieldset id="searchSection">
        <div class="input-layer">

            <label class="input-label" for="entrez_query">Entrez query</label>
            {{ renderHelpButton('entrez_query') }}
            <input class="bigger" type="text" name="entrez_query"
                   id="entrez_query" placeholder="Aspergillus[organism]"/>
        </div>
        <div class="input-layer">
            <label class="select-label" for="database_type">Database</label>
            <select class="select-options" id="database_type" name="database_type" required="required">
                <option value="nr">nr</option>
                <option value="refseq_protein">RefSeq protein</option>
                <option value="swissprot">Swissprot</option>
                <option value="pdbaa">pdbaa</option>
            </select>
            {{ renderHelpButton('database_type') }}
        </div>

        <div class="input-layer">
            <label class="input-label" for="max_hits">Maximum hits</label>
            {{ renderHelpButton('max_hits') }}
            <input type="number" required="required" name="hitlist_size"
                   id="max_hits" min="1" max="99999" step="1"
                   value="5000"/>
        </div>
    </fieldset>
</div>

<div id="filteringSectionFullFieldset">
    <label class="fieldset-label" for="filteringSection">Filtering</label>
    <fieldset id="filteringSection">
        <div class="input-layer">
            <label class="input-label" for="max_evalue">Max. e-value</label>
            {{ renderHelpButton('max_evalue') }}
            <input type="number" required="required" min="0.01" max="100" value="0.01" step="0.01" id="max_evalue"
               name="max_evalue"/>
        </div>
        <div class="input-layer">
            <label class="input-label" for="min_identity">Min. identity (%)</label>
            {{ renderHelpButton('min_identity') }}
            <input type="number" required="required" value="30" min="0" max="100" step="1"
                   id="min_identity" name="min_identity"/>
        </div>

        <div class="input-layer">
            <label class="input-label" for="min_query_coverage">Min. query coverage (%)</label>
            {{ renderHelpButton('min_query_coverage') }}
            <input type="number" required="required" min="0" max="100" step="1" value="50" id="min_query_coverage"
                   name="min_query_coverage"/>
        </div>
</fieldset>
</div>

    <label class="fieldset-label" for="clusteringSection">Clustering</label>
    <fieldset id="clusteringSection">
        <div class="input-layer">
            <label class="input-label" for="max_intergenic_gap">Max. intergenic gap</label>
            {{ renderHelpButton('max_intergenic_gap') }}
            <input type="number" id="max_intergenic_gap"
                   name="max_intergenic_gap" value="20000" min="0" max="999999" step="1" required="required"/>

        </div>

        <div class="input-layer">
            <label class="input-label" for="percentageQueryGenes">Percentage</label>
            {{ renderHelpButton('percentageQueryGenes') }}
            <input type="number" name="percentageQueryGenes" id="percentageQueryGenes" value="50" min="0" max="100" step="1" required="required"/>
        </div>

        <div class="input-layer">
            <label class="input-label" for="min_unique_query_hits">Min. unique query hits</label>
            {{ renderHelpButton('min_unique_query_hits') }}
            <input class="short" type="number" id="min_unique_query_hits"
                   name="min_unique_query_hits" value="3" step="1" min="0" max="150"
                   required="required"/>
        </div>

        <div class="input-layer">
            <label class="input-label" for="min_hits_in_clusters">Min. hits in clusters</label>
            {{ renderHelpButton('min_hits_in_clusters') }}
            <input class="short" type="number" id="min_hits_in_clusters"
                   name="min_hits_in_clusters" value="3" step="1" min="0" max="150" required="required"/>
        </div>

        <div class="input-layer"> {#  TODO: maybe as class=input-layer #}
            <input type="hidden" id="requiredSequences" name="requiredSequences" value=""/>
            <label class="select-label" for="requiredSequencesSelector">Required sequences</label>
            {{ renderHelpButton('requiredSequencesSelector') }}
            <select style="width: 60%;" id="requiredSequencesSelector" multiple="multiple">
                {% if headers %}
                    {% for head in headers %}
                    <option value="{{ head }}">{{ head }}</option>
                    {% endfor %}
                {% endif %}

            </select>
        </div>
    </fieldset>
    {{ result_table('search', "Sum") }}
    {{ result_table('search', "Bin") }}

    <label class="fieldset-label" for="generalOptionSection">Additional options</label>
    <fieldset id="generalOptionSection">
        <label class="checkbox-label">
            <input type="checkbox" id="sortClusters" name="sortClusters">Sort
                clusters
            </input>

        </label>
        {{ renderHelpButton('sortClusters', True) }}
    </fieldset>

    <label class="fieldset-label" for="intermediateGenesSection">Intermediate genes</label>
    <fieldset id="intermediateGenesSection">

        <label class="checkbox-label">
            <input type="checkbox" onclick="toggleDisabled('intermediate_max_distance', 'intermediate_max_clusters')" name="intermediate_genes">Find intermediate genes
        </label>
        {{ renderHelpButton('intermediate_genes', True) }}
        <div class="input-layer">
            <label class="input-label" for="intermediate_max_distance">Max. distance</label>
            {{ renderHelpButton('intermediate_max_distance') }}
            <input type="number" min="0" max="250000" value="5000" disabled="disabled" id="intermediate_max_distance" name="intermediate_max_distance"/>
        </div>
        <div class="input-layer">
            <label class="input-label" for="intermediate_max_clusters">Max. clusters</label>
            {{ renderHelpButton('intermediate_max_clusters') }}
            <input type="number" min="1" max="250" value="100" disabled="disabled" id="intermediate_max_clusters" name="intermediate_max_clusters"/>
        </div>
    </fieldset>
    <div class="input-layer centered">
        <input class="button" type="submit" id="submitSearchForm"/>
    </div>
    </form>
</div>

<div id="gneModuleContent" class="moduleContent" style="display: none">
    <form method="post" enctype="multipart/form-data" action="{{submit_url}}"
          name="gneOptionForm">

        <input type="hidden" name="job_type" value="gne" required="required"/>
        <label class="fieldset-label" for="gneInputSection">Input</label>
        <fieldset id="gneInputSection">
        {{ prev_session('gne', true, prev_run_id, false) }}
        </fieldset>

        {{ result_table('gne', 'Sum') }}

        <label class="fieldset-label" for="gneOptions">Extra options</label>
        <fieldset id="gneOptions">
            <div class="input-layer">
                <label class="input-label" for="max_intergenic_distance">Max. intergenic distance</label>
                {{ renderHelpButton('max_intergenic_distance') }}
                <input type="number" id="max_intergenic_distance" name="max_intergenic_distance" min="0" max="2500000" value="100000" required="required" step="1"/>
            </div>
            <div class="input-layer">
                <label class="input-label" for="sample_number">Number of samples</label>
                {{ renderHelpButton('sample_number') }}
                <input type="number" id="sample_number" name="sample_number"value="100" step="1" min="1" max="400" required="required"/>
            </div>
            <div class="input-layer">
                <label class="select-label" for="sampling_space">Sampling space</label>
                {{ renderHelpButton('sampling_space') }}
                <select class="select-options" name="sampling_space" id="sampling_space" required="required">
                    <option name="spaceLinear" value="linear">linear</option>
                    <option name="spaceLog" value="log">log</option>
                </select>
            </div>
        </fieldset>
        <div class="input-layer centered">
            <input type="submit" class="button" id="submitGNEForm"/>
        </div>
    </form>
</div>

<div id="clinkerContent" class="moduleContent" style="display: none">
    <form action="{{submit_url}}" method="post">
        <input type="hidden" name="job_type" value="clinker_full"/>

        <label class="fieldset-label" for="clinkerInputSection">Input</label>
        <fieldset id="clinkerInputSection">
            {{ prev_session('clinker', true, prev_run_id, true) }}
        </fieldset>

        <label class="fieldset-label" for="clinkerAlignmentSection">Alignment</label>
        <fieldset id="clinkerAlignmentSection">
            <label class="checkbox-label">
                <input type="checkbox" name="noAlign"/>Don't align clusters
            </label>
            {{ renderHelpButton('noAlign', True) }}
            <div class="input-layer">
                <label class="input-label" for="identity">Min. alignment sequence identity</label>
                {{ renderHelpButton('identity') }}
                <input type="number" id="identity" name="identity" required="required" min="0" max="1" value="0.3" step="0.01"/>
            </div>

        </fieldset>
        <label class="fieldset-label" for="clinkerOutputSection">Output</label>
        <fieldset id="clinkerOutputSection">
            <div class="input-layer">
                <label class="input-label"
                       for="clinkerDelim">Delimiter</label>
                {{ renderHelpButton('generalDelimiter') }}
                <input class="short" type="text" id="clinkerDelim" name="clinkerDelim" size="1" maxlength="1"/>
            </div>
            <div class="input-layer">
                <label class="input-label"
                       for="clinkerDecimals">Decimal places</label>
                {{ renderHelpButton('generalDecimals') }}
                <input class="short" type="number" id="clinkerDecimals" name="clinkerDecimals" value="2" step="1" min="0" max="9"
                       required="required"/>
            </div>

            <label class="checkbox-label">
                <input type="checkbox" name="hideLinkHeaders"/>Hide alignment column headers
            </label>
            {{ renderHelpButton('hideLinkHeaders', True) }}

            <div>
                <label class="checkbox-label">
                    <input type="checkbox" name="hideAlignHeaders"/>Hide alignment cluster name headers
                </label>
                {{ renderHelpButton('hideAlignHeaders', True) }}
            </div>
        </fieldset>

        <label class="fieldset-label" for="clinkerVisualiationSection">Additional options</label>
        <fieldset id="clinkerVisualiationSection">
            <label class="checkbox-label">
                <input type="checkbox" name="useFileOrder"/>Maintain order of input files
            </label>
            {{ renderHelpButton('useFileOrder', True) }}
        </fieldset>

        <div class="input-layer centered">
            <input class="button" type="submit"/>
        </div>
    </form>
</div>
</div>

{% endblock %}