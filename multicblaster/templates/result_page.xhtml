{% extends "base.xhtml" %}
{% from "macros.xhtml" import showNavigationBar %}

{% block title %}
    Status: {{ status }}
{% endblock %}

{% block navigationBar %}
    {{ showNavigationBar('results') }}
{% endblock %}

{% block scripts %}
    {% if module in modules_with_plots %}
{#document.getElementById('newWindow').src = '/plots/' + '{{ j_id }}';#}
    {% endif %}
{% endblock %}

<!--This page will show the status of the job (job unfinished), or the results of -->
<!--        the job (job finished)-->

{% block content %}
    <div style="border-bottom: 2px solid #5284a7">
    <p>The status of job: <b>{{ j_id }}</b> is: {{ status }}</p>
    <p>Job type: <b>{{ module }}</b></p>

    <form action="/download-results/{{j_id}}" method="post"
          enctype="multipart/form-data" name="download_settings">
    <input name="job_id" type="hidden" value="{{j_id}}"/>
    <select class="select-options" name="compression_type">
        {% for compr in compr_formats %}
        <option name="{{compr}}" value="{{compr}}">{{compr}}</option>

        {% endfor %}
    </select>
<!--    <input name=""/>-->
    <label class="button" for="download-button"><i class="fa fa-download"><span> Download</span></i></label>
    <input id="download-button" class="download-button" type="submit"></input>
    </form>


<label class="checkbox-label">
    <input onclick="toggleElementVisibility('logSection')" type="checkbox"/>Show log</label>
<div id="logSection" style="display: none">
    <p class="log">{{log_contents|safe}}</p>
</div>
    </div>

{% if downstream_modules %}
            <div class="partly-height">
            <div class="column leftColumn" style="border-bottom: 2px solid #5284a7;border-bottom-right-radius: 5px;">

        {% if 'clinker_query' in downstream_modules %}
            <form action="{{url_for('clinker_query')}}" method="post" onsubmit="addSelectedToForm('clinker_query')">
                <input type="hidden" name="job_id" value="{{j_id}}"/>
                <input type="hidden" name="selectedClusters" id="selectedClusters3" value=""/>
                <button class="button button-small" type="submit">Visualize with query clusters</button>
            </form>
        {% endif %}

        {% if 'clinker_full' in downstream_modules %}
            <a href="{{url_for('home_page', prev_run_id=j_id)}}?type=visualization"><button class="button button-small">Visualize everything</button></a>
        {% endif %}

        {% if 'gne' in downstream_modules %}
            <a href="{{url_for('home_page', prev_run_id=j_id)}}?type=gne"><button class="button button-small">Neighbourhood</button></a>
        {% endif %}

        {% if 'extract_sequences' in downstream_modules %}
    <form action="{{url_for('extract_sequences')}}" method="post" onsubmit="addSelectedToForm('sequences')">
        <input type="hidden" name="job_id" value="{{j_id}}"/>
        <input type="hidden" id="selectedQueries" name="selectedQueries" value=""/>
        <input type="hidden" id="selectedClusters" name="selectedClusters" value=""/>
        <button class="button button-small" type="submit">Extract sequences</button>
    </form>
        {% endif %}

        {% if 'extract_clusters' in downstream_modules %}
    <form action="{{url_for('extract_clusters')}}" method="post" onsubmit="addSelectedToForm('clusters')">
        <input type="hidden" name="job_id" value="{{j_id}}"/>
        <input type="hidden" name="selectedClusters" id="selectedClusters1" value=""/>
        <button class="button button-small" type="submit">Extract clusters</button>
    </form>
        {% endif %}

        {% if 'corason' in downstream_modules %}
    <form action="{{ url_for('corason')}}" method="post" onsubmit="addSelectedToForm('corason')">
        <input type="hidden" name="job_id" value="{{j_id}}"/>
        <input type="hidden" name="selectedQuery" id="selectedQuery" value=""/>
        <input type="hidden" name="selectedClusters" id="selectedClusters2" value=""/>
        <input type="hidden" name="selectedReferenceCluster" id="referenceCluster" value=""/>
        <button class="button button-small" type="submit" id="corasonSubmit" disabled="disabled">Use CORASON</button>
    </form>
        {% endif %}

        {% if 'recompute' in downstream_modules %}
            <a href="{{url_for('home_page', prev_run_id=j_id)}}?type=recompute"><button class="button button-small">Recompute</button></a>
        {% endif %}

            </div>
            <div class="column rightColumn">
<label for="selectedQueriesOverview">Selected queries</label>
<ul id="selectedQueriesOverview">
    <li>No queries selected</li>
</ul>

<label for="selectedClustersOverview">Selected clusters</label>
<ul id="selectedClustersOverview">
    <li>No clusters selected</li>
</ul>
<label for="selectedReferenceCluster">Selected reference cluster</label>
<ul id="selectedReferenceCluster">
    <li>No reference cluster selected</li>
</ul>
            </div>
            </div>
    {% endif %}
{#            TODO: center the iframe and still be able to click the downstream buttons#}
    {% if module in modules_with_plots %}
<div>
{#TODO: lazy loading doesnt work yet#}
<div style="margin: auto;width: 60%;">

    <p style="display: inline-block;"  id="resultLoadedMessage">Result is being loaded.. File size: {{ content_size }}</p>
    <img id="loadingImage" style="vertical-align: middle; width: 80px; height: auto;" src="{{ url_for('static', filename='images/dna_loader.gif') }}" alt="loading"/>
</div>
    {% if module in ['search', 'recompute'] %}
        {% set onload = 'loadedIframe(this);postLoadingIFrame()' %}
    {% elif module in ['clinker_full', 'clinker_query'] %}
        {% set onload = 'postLoadingIFrame()' %}
    {% endif %}
<iframe onload="showPreviousJobs(true)" style="display: none"></iframe> {# Dummy frame to load previous jobs before potentially large file is downloaded #}
    <iframe onload="{{onload}}" height="800" id="newWindow" src="/plots/{{ j_id }}" title="Generated HTML plot"></iframe>
</div>

        {% endif %}

{% endblock %}










