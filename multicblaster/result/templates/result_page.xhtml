{% extends "base.xhtml" %}
{% from "macros.xhtml" import showNavigationBar %}
{% from "macros.xhtml" import renderHelpButton %}

{% block title %}
    {% if job_title %}
        {{ job_title }}: {{ status.capitalize() }}
    {% else %}
        {{ status.capitalize() }}
    {% endif %}
{% endblock %}

{% block navigationBar %}
    {{ showNavigationBar('results') }}
{% endblock %}

{% block content %}
    <div>
        <div class="indent">
        {% if job_title %}
            <h2>{{ job_title }}</h2>
        {% endif %}
            <h3>{{ module }} ({{ j_id }})</h3>
            <p>Current status: <b>{{ status }}</b></p>

            <form action="{{ url_for('result.return_user_download', job_id=j_id) }}" method="post"
                  enctype="multipart/form-data" name="download_settings">
                <input name="job_id" type="hidden" value="{{j_id}}"/>

                <label style="margin-top: 1%;" class="button" for="download-button"><i class="fa fa-download"><span> Download results</span></i></label>
                <input id="download-button" class="download-button" type="submit"></input>
            </form>
        </div>

    {% if connected_jobs %}
        <div style="margin-top: 1%" id="connectedJobsCheckbox">
            <label class="checkbox-label" for="connectedJobsToggle">
                <input type="checkbox" id="connectedJobsToggle" onclick="toggleElementVisibility('connectedJobs')"/>Show linked jobs
            </label>
        </div>

    <div id="connectedJobs" class="no-display indent">
        <table>
            <tr>
                <th>Job ID</th>
                <th>Module</th>
                <th>Status</th>
                <th>Category</th>
            </tr>

        {% for id, module, status, job_category in connected_jobs %}
            <tr>
                <td class="job-display"><a href="{{ url_for('result.show_result', job_id=id) }}">{{ id }}</a></td>
                <td>{{ module }}</td>
                <td>{{ status }}</td>
                <td>{{ job_category }}</td>
            </tr>
        {% endfor %}
        </table>
    </div>
    {% endif %}

{% if downstream_modules %}
            <div class="partly-height">
    <div>
            <div class="column leftColumn downstream-div" id="downStreamModulesDiv">
{#            TODO: make class for style except width#}

        {% if 'clinker_query' in downstream_modules %}
            <form action="{{url_for('downstream.clinker_query')}}" method="post" onsubmit="addSelectedToForm('clinker_query')">
                <input type="hidden" name="job_id" value="{{j_id}}"/>
                <input type="hidden" name="selectedClusters" id="selectedClusters3" value=""/>
                <button class="button button-small" type="submit">Visualize with query clusters</button>
            </form>
{#            {{ renderHelpButton('module_clinker_query') }}#}
{#            TODO: add help buttons for downstream modules#}

        {% endif %}

        {% if 'clinker_full' in downstream_modules %}
            <form action="{{url_for('downstream.clinker_full')}}" method="get">
                <input type="hidden" name="prev_id" value="{{ j_id }}"/>
                <button class="button button-small" type="submit">Visualize everything</button>
            </form>
{#            <a href="{{url_for('home_page', prev_run_id=j_id)}}?type=visualization"><button class="button button-small">Visualize everything</button></a>#}
        {% endif %}

        {% if 'gne' in downstream_modules %}
            <form action="{{url_for('downstream.neighbourhood')}}" method="get">
                <input type="hidden" name="prev_id" value="{{ j_id }}"/>
                <button class="button button-small" type="submit">Neighbourhood</button>
            </form>
{#            <a href="{{url_for('downstream.neighbourhood')}}"><button class="button button-small">Neighbourhood</button></a>#}
        {% endif %}

        {% if 'extract_sequences' in downstream_modules %}
    <form action="{{url_for('downstream.extract_sequences')}}" method="post" onsubmit="addSelectedToForm('sequences')">
        <input type="hidden" name="job_id" value="{{j_id}}"/>
        <input type="hidden" id="selectedQueries" name="selectedQueries" value=""/>
        <input type="hidden" id="selectedClusters" name="selectedClusters" value=""/>
        <button class="button button-small" type="submit">Extract sequences</button>
    </form>
        {% endif %}

        {% if 'extract_clusters' in downstream_modules %}
    <form action="{{url_for('downstream.extract_clusters')}}" method="post" onsubmit="addSelectedToForm('clusters')">
        <input type="hidden" name="job_id" value="{{j_id}}"/>
        <input type="hidden" name="selectedClusters" id="selectedClusters1" value=""/>
        <button class="button button-small" type="submit">Extract clusters</button>
    </form>
        {% endif %}

        {% if 'corason' in downstream_modules %}
    <form action="{{ url_for('downstream.corason')}}" method="post" onsubmit="addSelectedToForm('corason')">
        <input type="hidden" name="job_id" value="{{j_id}}"/>
        <input type="hidden" name="selectedQuery" id="selectedQuery" value=""/>
        <input type="hidden" name="selectedClusters" id="selectedClusters2" value=""/>
        <input type="hidden" name="unselectedClusters" id="unselectedClusters2" value=""/>
{#        <input type="hidden" name="selectedReferenceCluster" id="referenceCluster" value=""/>#}
        <button class="button button-small" type="submit" id="corasonSubmit" disabled="disabled">CORASON</button>
    </form>
        {% endif %}

        {% if 'recompute' in downstream_modules %}
            <a href="{{url_for('home_page', prev_run_id=j_id)}}?type=recompute&resetQueries=0"><button class="button button-small">Recompute</button></a>
        {% endif %}

            </div>
        <div class="column middleColumn" id="middleColumnDiv" style="width: 80%;">
{#            <label for="selectedQueriesOverview">Selected queries</label>#}
{#            <ul id="selectedQueriesOverview">#}
{#                <li>No queries selected</li>#}
{#            </ul>#}
{##}
{#            <label for="selectedClustersOverview">Selected clusters</label>#}
{#            <ul id="selectedClustersOverview">#}
{#                <li>No clusters selected</li>#}
{#            </ul>#}
{#            <label for="selectedReferenceCluster">Selected reference cluster</label>#}
{#            <ul id="selectedReferenceCluster">#}
{#                <li>No reference cluster selected</li>#}
{#            </ul>#}
{#        </div>#}

    {% endif %}
{#            TODO: center the iframe and still be able to click the downstream buttons#}

    {% if module in modules_with_plots %}
        {% if module not in ('clinker_full', 'gne') %}
        <div>
            <div class="centered">
                <button class="button smaller" onclick="showSelection('cluster')">Select clusters</button>
            {% if module != 'clinker_query' %}
                <button class="button smaller" onclick="showSelection('query')">Select queries</button>
            {% endif %}
                {#                {{ renderHelpButton('downstream_select') }}#}
            </div>

            <div>
                <div class="centered" id="clusterSelection">

                    <select id="unselectedClustersSelector" class="multiselect-large selector-custom-height" multiple="multiple">
                    </select>

                    <button onclick="moveSelectedElements('unselected', 'Clusters')"><<</button>
                    <button onclick="moveSelectedElements('selected', 'Clusters')">>></button>

                    <select id="selectedClustersSelector" class="multiselect-large selector-custom-height" multiple="multiple">
                        {#                        <option>ads</option>#}
                    </select>
                </div>

            {% if module != 'clinker_query' %}
                <div id="queriesSelection" class="centered no-display">
                    <select id="unselectedQueriesSelector" multiple="multiple" class="multiselect-small selector-custom-height">
                    </select>

                    <button onclick="moveSelectedElements('unselected', 'Queries')"><<</button>
                    <button onclick="moveSelectedElements('selected', 'Queries')">>></button>

                    <select id="selectedQueriesSelector" multiple="multiple" class="multiselect-small selector-custom-height">
                        {#            <option></option>#}
                    </select>
                </div>
            {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

<div style="margin: auto;width: 60%;">

    <p style="display: inline-block;padding-left: 10px;"  id="resultLoadedMessage">Result is being loaded.. File size: {{ content_size }}</p>
    <img id="loadingImage" style="vertical-align: middle; width: 80px; height: auto;" src="{{ url_for('static', filename='images/dna_loader.gif') }}" alt="loading"/>
</div>
    {% if module in ['search', 'recompute'] %}
{#        TODO: postLoadingIFrame is now everywhere, so we can do it standard#}
        {% set onload = 'getOutputFromPlot("search");postLoadingIFrame()' %}
    {% elif module == 'clinker_query' %}
        {% set onload = 'getOutputFromPlot("visualize");postLoadingIFrame()' %}
    {% elif module == 'clinker_full' %}
        {% set onload = 'postLoadingIFrame()' %}
        {% for connected_job in connected_jobs %}
            {% if connected_job[3] == 'depending' %}
                <p style="padding-left: 30px;"> <a href="{{ url_for('result.return_user_download', job_id=connected_job[0]) }}">Click this sentence to download the sequences of the clusters shown below.</a></p>
            {% endif %}
        {% endfor %}

    {% elif module == 'gne' %}
        {% set onload = 'postLoadingIFrame()' %}
    {% endif %}

<iframe onload="showPreviousJobs(true)" class="no-display"></iframe> {# Dummy frame to load previous jobs before potentially large file is downloaded #}
    <iframe onload="{{onload}}" height="800" id="newWindow" src="{{ url_for('result.get_plot_contents', job_id=j_id) }}" title="Generated HTML plot"></iframe>
</div>
        {% endif %}

{% endblock %}
